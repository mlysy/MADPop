<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Martin Lysy, Wookjung P. Kim, Terin Robinson" />

<meta name="date" content="2017-01-15" />

<title>Bayesian Testing of Equal Genotype Proportions between Multiple Populations</title>




<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Bayesian Testing of Equal Genotype Proportions between Multiple Populations</h1>
<h4 class="author"><em>Martin Lysy, Wookjung P. Kim, Terin Robinson</em></h4>
<h4 class="date"><em>2017-01-15</em></h4>



<p>This tutorial shows how to use the <strong>MADPop</strong> package to test for genetic differences between two populations, of which the individuals of a same species contain a variable number of alleles.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(MADPop)</code></pre></div>
<div id="pre-processing" class="section level2">
<h2>Pre-Processing</h2>
<p>Our data consists of <span class="math inline">\(N = 215\)</span> recordings of Major Histocompatibility Complex (MHC) genotypes of lake trout from <span class="math inline">\(K = 11\)</span> lakes in Ontario, Canada. For each of the fish, between 1-4 alleles in the MHC genotype are recorded. This is partially because duplicate genes are undetectable by current instrumentation, and possibly because the fish possess a variable number of alleles of a given MHC gene.</p>
<p>Our dataset <code>fish215</code> is included with <strong>MADPop</strong>. A random sample from it looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(fish215[<span class="kw">sample</span>(nObs),])</code></pre></div>
<pre><code>##             Lake  A1  A2  A3  A4
## 194    Macdonald z.1            
## 65  Michipicoten r.4     r.7    
## 88       Opeongo     r.5 r.4 r.2
## 90       Opeongo r.4 r.2 r.5    
## 200       Seneca     w.8 t.6    
## 4          Hogan r.4     r.2 r.7</code></pre>
<p>The first column is the lake name (or population ID) for each sample, the remaining four columns are for potentially recorded allele codes (<code>A1</code>-<code>A4</code>). Here the code to identify a unique allele is a small letter followed by a number, but it could have been the sequence of integers <span class="math inline">\(1, 2,\ldots, A\)</span>, which for the <code>fish215</code> data is <span class="math inline">\(A = 57\)</span> unique alleles.</p>
<p>It is relatively straightforward to import a CSV file into the format above. An example of this is given along with our raw data in the <strong>extdata</strong> directory of the local copy of the <strong>MADPop</strong> package.</p>
</div>
<div id="two-population-comparisons" class="section level2">
<h2>Two-Population Comparisons</h2>
<p>Suppose that we wish to compare two lakes, say Dickey and Simcoe. The allele counts in these lakes are in the table below. It is a subset of the full contingency table on all <span class="math inline">\(K = 11\)</span> lakes, which is produced by the <strong>MADPop</strong> function <code>UM.suff</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">popId &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Dickey&quot;</span>, <span class="st">&quot;Simcoe&quot;</span>)          <span class="co"># lakes to compare</span>
Xsuff &lt;-<span class="st"> </span><span class="kw">UM.suff</span>(fish215)             <span class="co"># summary statistics for dataset</span>
ctab &lt;-<span class="st"> </span>Xsuff$tab[popId,]             <span class="co"># contingency table</span>
ctab &lt;-<span class="st"> </span>ctab[,<span class="kw">colSums</span>(ctab) &gt;<span class="st"> </span><span class="dv">0</span>] <span class="co"># remove alleles with no counts</span>
<span class="co">#ctab</span>
<span class="kw">rbind</span>(ctab, <span class="dt">Total =</span> <span class="kw">colSums</span>(ctab))</code></pre></div>
<pre><code>##        1.20 1.4.5 1.4.9.45 1.5 10 20 20.54 27.28.29 3 4 4.10 4.11 4.20.27
## Dickey    1     1        0   2  0  2     1        1 0 0    1    0       1
## Simcoe    0     0        1   1  2  0     0        0 1 1    2    1       0
## Total     1     1        1   3  2  2     1        1 1 1    3    1       1
##        4.20.31 4.20.45 4.27 4.33 4.5 4.53.55 4.56 4.7 4.7.10 5 5.20 5.30
## Dickey       1       1    1    0   1       1    1   0      0 0    1    1
## Simcoe       0       0    0    1   1       0    0   3      1 1    0    0
## Total        1       1    1    1   2       1    1   3      1 1    1    1
##        5.32 5.7 7 9.11
## Dickey    1   1 0    0
## Simcoe    0   1 2    1
## Total     1   2 2    1</code></pre>
<p>The unique allele identifiers are encoded as integers between <span class="math inline">\(1\)</span> and <span class="math inline">\(A\)</span> and separated by dots. The original allele names are stored in <code>Xsuff$A</code>, such that the genotype of the first column <code>1.20</code> is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gtype &lt;-<span class="st"> </span><span class="kw">colnames</span>(ctab)[<span class="dv">1</span>]
gtype &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">strsplit</span>(gtype, <span class="st">&quot;[.]&quot;</span>)[[<span class="dv">1</span>]])
gtype</code></pre></div>
<pre><code>## [1]  1 20</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(gtype) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;A&quot;</span>, gtype)
<span class="kw">sapply</span>(gtype, function(ii) Xsuff$A[ii])</code></pre></div>
<pre><code>##    A1   A20 
## &quot;r.1&quot; &quot;u.4&quot;</code></pre>
<p>There are <span class="math inline">\(C = 29\)</span> genotype combinations observed in these two lakes, corresponding to each column of the table.</p>
<div id="multinomial-model" class="section level3">
<h3>Multinomial Model</h3>
<p>In the two-population problem we have <span class="math inline">\(K = 2\)</span> lakes with <span class="math inline">\(N_1\)</span> and <span class="math inline">\(N_2\)</span> fish sampled from each. Let <span class="math inline">\({\boldsymbol Y}_k = (Y_{k1}, \ldots Y_{kC})\)</span> denote the counts for each genotype observed in lake <span class="math inline">\(k\)</span>, such that <span class="math inline">\(\sum_{i=1}^C Y_{ki} = N_k\)</span>. The sampling model for these data is <span class="math display">\[
{\boldsymbol Y}_k {\stackrel{\textrm{ind}}{\sim}}\textrm{Multinomial}(N_k, {\boldsymbol \rho}_k), \quad k = 1,2,
\]</span> where <span class="math inline">\({\boldsymbol \rho}_k = (\rho_{k1},...,\rho_{kC})\)</span> are the population proportions of each genotype, and <span class="math inline">\(\sum_{i=1}^C \rho_{ki} = 1\)</span>.</p>
</div>
<div id="hypothesis-testing" class="section level3">
<h3>Hypothesis Testing</h3>
<p>Our objective is to test <span class="math display">\[
\begin{split}
H_0 &amp;: \textrm{The two populations have the same genotype proportions} \\
&amp; \phantom{: } \iff {\boldsymbol \rho}_1 = {\boldsymbol \rho}_2.
\end{split}
\]</span> The classical test statistics for assessing <span class="math inline">\(H_0\)</span> are Pearson’s Chi-Square statistic <span class="math inline">\(\mathcal X\)</span> and the Likelihood Ratio statistic <span class="math inline">\(\Lambda\)</span>, <span class="math display">\[
\mathcal X = \sum_{k=1}^2 \sum_{i=1}^C \frac{(N_k\hat\rho_i - Y_{ki})^2}{N_k\hat\rho_i}, \qquad \Lambda = 2 \sum_{k=1}^2 \sum_{i=1}^C Y_{ki} \log\left(\frac{Y_{ki}}{N_k\hat\rho_i}\right), \qquad \hat \rho_i = \frac{Y_{1i} + Y_{2i}}{N_1 + N_2}.
\]</span> Under <span class="math inline">\(H_0\)</span>, the asymptotic distribution of either of these test statistics <span class="math inline">\(T = \mathcal X\)</span> or <span class="math inline">\(\Lambda\)</span> is <span class="math inline">\(\chi^2_{(C-1)}\)</span>, such that the <span class="math inline">\(p\)</span>-value <span class="math display">\[
{\textrm{p}_\textrm{v}}= \textrm{Pr}(T &gt; T_\textrm{obs} \mid H_0)
\]</span> for an observed value of <span class="math inline">\(T_\textrm{obs}\)</span> can be estimated as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># observed values of the test statistics</span>
chi2.obs &lt;-<span class="st"> </span><span class="kw">chi2.stat</span>(ctab) <span class="co"># Pearson's chi^2</span>
LRT.obs &lt;-<span class="st"> </span><span class="kw">LRT.stat</span>(ctab) <span class="co"># LR test statistic</span>
T.obs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">chi2 =</span> chi2.obs, <span class="dt">LRT =</span> LRT.obs)
<span class="co"># p-value with asymptotic calculation</span>
C &lt;-<span class="st"> </span><span class="kw">ncol</span>(ctab)
pv.asy &lt;-<span class="st"> </span><span class="kw">pchisq</span>(<span class="dt">q =</span> T.obs, <span class="dt">df =</span> C<span class="dv">-1</span>, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)
<span class="kw">signif</span>(pv.asy, <span class="dv">2</span>)</code></pre></div>
<pre><code>##  chi2   LRT 
## 0.330 0.041</code></pre>
<p>The Chi-Square and LR tests are asymptotically equivalent and so should give roughly the same <span class="math inline">\(p\)</span>-values. The huge discrepancy observed here indicates that the sample sizes are too small for asymptotics to kick in. A more reliable <span class="math inline">\(p\)</span>-value estimate can be obtained by the Bootstrap method, which in this case consists of simulating <span class="math inline">\(M\)</span> contigency tables with <span class="math inline">\({\boldsymbol Y}_k^{(m)} {\stackrel{\textrm{ind}}{\sim}}\textrm{Multinomial}(N_k, \hat{{\boldsymbol \rho}})\)</span>, <span class="math inline">\(m = 1, \ldots, M\)</span>, where <span class="math inline">\(\hat{{\boldsymbol \rho}}\)</span> is the estimate of the common probability vector <span class="math inline">\({\boldsymbol \rho}_1 = {\boldsymbol \rho}_2\)</span> under <span class="math inline">\(H_0\)</span>. For each contingency table <span class="math inline">\(({\boldsymbol Y}_1^{(m)}, {\boldsymbol Y}_2^{(m)})\)</span>, we calculate the test statistic <span class="math inline">\(T^{(m)}\)</span>, and the bootstrapped p-value is defined as <span class="math display">\[
{\textrm{p}_\textrm{v}^{\textrm{boot}}}= \frac 1 M \sum_{m=1}^M \delta(T^{(m)} \ge T_\textrm{obs}).
\]</span> <span class="math inline">\({\textrm{p}_\textrm{v}^{\textrm{boot}}}\)</span> is calculated with <strong>MADPop</strong> as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">N1 &lt;-<span class="st"> </span><span class="kw">sum</span>(ctab[<span class="dv">1</span>,])                     <span class="co"># size of first sample</span>
N2 &lt;-<span class="st"> </span><span class="kw">sum</span>(ctab[<span class="dv">2</span>,])                     <span class="co"># size of second sample</span>
rho.hat &lt;-<span class="st"> </span><span class="kw">colSums</span>(ctab)/(N1+N2)        <span class="co"># common probability vector</span>
<span class="co"># bootstrap distribution of the test statistics</span>
<span class="co"># set verbose = TRUE for progress output</span>
<span class="kw">system.time</span>({
  T.boot &lt;-<span class="st"> </span><span class="kw">UM.eqtest</span>(<span class="dt">N1 =</span> N1, <span class="dt">N2 =</span> N2, <span class="dt">p0 =</span> rho.hat, <span class="dt">nreps =</span><span class="fl">1e4</span>,
                      <span class="dt">verbose =</span> <span class="ot">FALSE</span>)
})</code></pre></div>
<pre><code>##    user  system elapsed 
##    0.97    0.00    0.97</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># bootstrap p-value</span>
pv.boot &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">t</span>(T.boot) &gt;=<span class="st"> </span>T.obs)
<span class="kw">signif</span>(pv.boot, <span class="dv">2</span>)</code></pre></div>
<pre><code>##   chi2    LRT 
## 0.0074 0.0068</code></pre>
<p>Note that the bootstrap <span class="math inline">\(p\)</span>-values for both tests are roughly the same and decisively reject <span class="math inline">\(H_0\)</span>, whereas the less reliable asymptotic <span class="math inline">\(p\)</span>-values both failed to reject (at quite different significance levels).</p>
</div>
</div>
<div id="pairwise-comparisons-between-multiple-populations" class="section level2">
<h2>Pairwise Comparisons between Multiple Populations</h2>
<p>Bootstrapping overcomes many deficiencies of the asymptotic <span class="math inline">\(p\)</span>-value calculation. However, bootstrapping has a tendency to reject <span class="math inline">\(H_0\)</span> when sample sizes are small. To see why this is, consider all columns of <code>ctab</code> which have only one genotype count between the two lakes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">itab1 &lt;-<span class="st"> </span><span class="kw">colSums</span>(ctab) ==<span class="st"> </span><span class="dv">1</span>             <span class="co"># single count genotypes</span>
<span class="kw">cbind</span>(ctab[,itab1],
      <span class="dt">Other =</span> <span class="kw">rowSums</span>(ctab[,!itab1]),
      <span class="dt">Total =</span> <span class="kw">rowSums</span>(ctab))</code></pre></div>
<pre><code>##        1.20 1.4.5 1.4.9.45 20.54 27.28.29 3 4 4.11 4.20.27 4.20.31 4.20.45
## Dickey    1     1        0     1        1 0 0    0       1       1       1
## Simcoe    0     0        1     0        0 1 1    1       0       0       0
##        4.27 4.33 4.53.55 4.56 4.7.10 5 5.20 5.30 5.32 9.11 Other Total
## Dickey    1    0       1    1      0 0    1    1    1    0     7    20
## Simcoe    0    1       0    0      1 1    0    0    0    1    12    20</code></pre>
<p>There are <span class="math inline">\(c_1 = 21\)</span> such columns, accounting for <span class="math inline">\(\hat p_1 = 0.525\)</span> of the common genotype distribution under <span class="math inline">\(H_0\)</span>, as estimated from the two-lake sample. For each of these columns, observing counts in one lake but not the other provides evidence against <span class="math inline">\(H_0\)</span>. Moreover, under the estimated common distribution <span class="math inline">\(\hat {{\boldsymbol \rho}}\)</span>, it is very unlikely to have counts in only one of the lakes for each of these <span class="math inline">\(c_1 = 21\)</span> genotypes. Therefore, the data appear to provide very strong evidence against <span class="math inline">\(H_0\)</span>. However, it is not so unlikely to have <span class="math inline">\(c_1 = 21\)</span> one-count genotypes if the true number of unique genotypes in these two lakes is much larger than the observed value of <span class="math inline">\(C = 29\)</span>. With <span class="math inline">\(C = 29\)</span> unique genotypes in only <span class="math inline">\(N = N_1 + N_2 = 40\)</span> fish samples, it is quite plausible that a new sample of fish would yield several genotypes which are not present in the original two-lake sample <code>ctab</code>.</p>
<p>One way to obtain information about the unobserved genotypes in lakes Dickey and Simcoe is to consider the genotypes in <em>all</em> <span class="math inline">\(K = 11\)</span> Ontario lakes for which we have collected data. A natural way to do this is through a hierarchical model: <span class="math display">\[
\begin{split}
{\boldsymbol Y}_k \mid {\boldsymbol \rho}_k &amp; {\stackrel{\textrm{ind}}{\sim}}\textrm{Multinomial}(N_k, {\boldsymbol \rho}_k), \quad k = 1,\ldots,K \\
{\boldsymbol \rho}_k &amp; {\stackrel{\textrm{iid}}{\sim}}\textrm{Dirichlet}({\boldsymbol \alpha}), \qquad {\boldsymbol \alpha}= (\alpha_1, \ldots, \alpha_C).
\end{split}
\]</span> That is, each population is allowed to have its own probability vector <span class="math inline">\({\boldsymbol \rho}_k\)</span>. However, these probability vectors are drawn from a common Dirichlet distribution. The common distribution specifies that before any data is drawn, we have <span class="math display">\[
E[{\boldsymbol \rho}] = \bar {\boldsymbol \alpha}, \qquad {\textrm{var}}(\rho_i) = \frac{(\bar \alpha_i)(1-\bar \alpha_i)}{\alpha_0 + 1},
\]</span> where <span class="math inline">\(\alpha_0 = \sum_{i=1}^C \alpha_i\)</span> and <span class="math inline">\(\bar{{\boldsymbol \alpha}} = {\boldsymbol \alpha}/ \alpha_0\)</span>. Moreover, the posterior distribution of <span class="math inline">\({\boldsymbol \rho}_k\)</span> given <span class="math inline">\({\boldsymbol \alpha}\)</span> and the data is also Dirichlet: <span class="math display">\[
{\boldsymbol \rho}_k \mid {\boldsymbol Y}{\stackrel{\textrm{ind}}{\sim}}\textrm{Dirichlet}({\boldsymbol \alpha}+ {\boldsymbol Y}_k).
\]</span> In this sense, the posterior estimate of the proportion of genotype <span class="math inline">\(i\)</span> in population <span class="math inline">\(k\)</span>, <span class="math inline">\(\rho_{ki}\)</span>, can be non-zero even if <span class="math inline">\(Y*{ki} = 0\)</span>. In practice, <span class="math inline">\({\boldsymbol \alpha}\)</span> is estimated from <span class="math inline">\({\boldsymbol Y}\)</span>, the data from all <span class="math inline">\(K\)</span> populations (details in the following section). The extent to which the genotypes observed in one lake affect inference in the other lakes is determined by <span class="math inline">\(\alpha*0\)</span> (the larger this value, the larger the effect).</p>
<div id="parameter-estimation" class="section level3">
<h3>Parameter Estimation</h3>
<p>The likelihood function for this model corresponds to a Dirichlet-Multinomial distribution, <span class="math display">\[
\begin{split}
\mathcal L({\boldsymbol \alpha}\mid {\boldsymbol Y}) = \prod_{k=1}^K p({\boldsymbol Y}_k \mid {\boldsymbol \alpha}) &amp; = \prod_{k=1}^K \int p({\boldsymbol Y}_k \mid {\boldsymbol \rho}_k) p({\boldsymbol \rho}_k \mid {\boldsymbol \alpha}) \,\mathrm{d}{\boldsymbol \rho}_k \\
&amp; = \prod_{k=1}^K \left[\frac{N_k!\cdot\Gamma(\alpha_0)}{\Gamma(N_k+\alpha_0)} \prod_{i=1}^C \frac{\Gamma(Y_{ki} + \alpha_i)}{Y_{ki}!\cdot\Gamma(\alpha_i)}\right],
\end{split}
\]</span> from which <span class="math inline">\({\boldsymbol \alpha}\)</span> can be estimated by maximum likelihood <span class="citation">(Minka <a href="#ref-minka00">2000</a>)</span>. Alternatively we estimate <span class="math inline">\({\boldsymbol \alpha}\)</span> using a Bayesian approach, which is more readily extensible to more complex genotype models, for which <span class="math inline">\(\mathcal L({\boldsymbol \alpha}\mid {\boldsymbol Y})\)</span> has no closed form (see Future Work).</p>
<p>First, we specify a prior distribution <span class="math display">\[
\pi(\alpha_0, \bar {\boldsymbol \alpha}) = \frac{1}{(1+ \alpha_0)^2},
\]</span> which is a uniform distribution on the prior probability vector <span class="math inline">\(\bar {\boldsymbol \alpha}\)</span>, and a uniform distribution on the variance-like parameter <span class="math inline">\(A = (1+\alpha_0)^{-1}\)</span>, in the sense that the prior mean and variance of a given genotype population probability are <span class="math display">\[
E[\rho_{kj}] = \tilde \alpha_j, \qquad {\textrm{var}}(\rho_{kj}) = A \cdot \tilde \alpha_j(1-\tilde \alpha_j).
\]</span> Then, we sample from the posterior distribution <span class="math inline">\(p({\boldsymbol \alpha}\mid {\boldsymbol Y}) \propto {\mathcal L}({\boldsymbol \alpha}\mid {\boldsymbol Y}) \pi({\boldsymbol \alpha})\)</span> using a Markov chain Monte Carlo (MCMC) algorithm provided by the <strong>stan</strong> programming language <span class="citation">(Stan Development Team <a href="#ref-rstan">2016</a>)</span>, as detailed below.</p>
</div>
</div>
<div id="bayesian-hypothesis-testing" class="section level2">
<h2>Bayesian Hypothesis Testing</h2>
<p>Under the hierarchical model, the null hypothesis of equal genetic proportions between two populations, say <span class="math inline">\(k = 1,2\)</span>, is <span class="math inline">\(H_0: {\boldsymbol \rho}_1 = {\boldsymbol \rho}_2 = {\boldsymbol \rho}_{12}\)</span>. Our Bayesian hypothesis-testing strategy is implemented in two steps:</p>
<ol style="list-style-type: decimal">
<li>Sample from the posterior distribution <span class="math inline">\(p({\boldsymbol \alpha}\mid {\boldsymbol Y}, H_0)\)</span>.</li>
<li>Sample from the posterior distribution of either classical test statistic, <span class="math inline">\(T = \mathcal X\)</span> or <span class="math inline">\(\Lambda\)</span>, thus obtaining a <em>posterior p-value</em> <span class="math display">\[
{\textrm{p}_\textrm{v}^{\textrm{post}}}= \textrm{Pr}(T &gt; T_\textrm{obs} \mid {\boldsymbol Y}, H_0).
\]</span></li>
</ol>
<div id="mcmc-sampling-from-the-posterior-distribution" class="section level3">
<h3>MCMC Sampling from the Posterior Distribution</h3>
<p>In order to estimate <span class="math inline">\({\boldsymbol \alpha}\)</span> under <span class="math inline">\(H_0\)</span>, we apply the Dirichlet-Multinomial distribution to <span class="math inline">\(K-1\)</span> lakes, with the first two being collapsed into a common count vector <span class="math inline">\({\boldsymbol Y}_{12} = {\boldsymbol Y}_1 + {\boldsymbol Y}_2\)</span> with sample size <span class="math inline">\(N_{12} = N_1 + N_2\)</span>. MCMC sampling is implemented via a Hybrid Monte Carlo (HMC) variant provided by the <strong>R</strong> package <strong>rstan</strong>. In <strong>MADPop</strong>, sampling from <span class="math inline">\(p({\boldsymbol \alpha}\mid {\boldsymbol Y}, H_0)\)</span> is accomplished with the function <code>hUM.post</code>, where “hUM” stands for <em>hierarchical Unconstrained Multinomial</em> model. We start by merging the two samples from equal distributions under <span class="math inline">\(H_0\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">popId                                   <span class="co"># equal lakes under H0</span></code></pre></div>
<pre><code>## [1] &quot;Dickey&quot; &quot;Simcoe&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eqId0 &lt;-<span class="st"> </span><span class="kw">paste0</span>(popId, <span class="dt">collapse =</span> <span class="st">&quot;.&quot;</span>)  <span class="co"># merged lake name</span>
popId0 &lt;-<span class="st"> </span><span class="kw">as.character</span>(fish215$Lake)    <span class="co"># all lake names</span>
popId0[popId0 %in%<span class="st"> </span>popId] &lt;-<span class="st"> </span>eqId0
<span class="kw">table</span>(popId0, <span class="dt">dnn =</span> <span class="ot">NULL</span>)               <span class="co"># merged lake counts</span></code></pre></div>
<pre><code>##       Crystal Dickey.Simcoe         Hogan     Kingscote     Macdonald 
##            20            40            21            18            19 
##       Manitou  Michipicoten       Opeongo        Seneca         Slate 
##            20            20            20            18            19</code></pre>
<p>Next, we sample from <span class="math inline">\(p({\boldsymbol \alpha}\mid {\boldsymbol Y}, H_0)\)</span> using <strong>rstan</strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">X0 &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">Id =</span> popId0, fish215[-<span class="dv">1</span>])  <span class="co"># allele data with merged lakes</span>

nsamples &lt;-<span class="st"> </span><span class="fl">1e4</span>
fit0 &lt;-<span class="st"> </span><span class="kw">hUM.post</span>(<span class="dt">nsamples =</span> nsamples, <span class="dt">X =</span> X0,
                 <span class="dt">rhoId =</span> eqId0,     <span class="co"># output rho only for merged lakes</span>
                 <span class="dt">chains =</span> <span class="dv">1</span>,  <span class="co"># next two arguments are passed to rstan</span>
                 <span class="dt">warmup =</span> <span class="kw">min</span>(<span class="fl">1e4</span>, <span class="kw">floor</span>(nsamples/<span class="dv">10</span>)),
                 <span class="dt">full.stan.out =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL 'DirichletMultinomial' NOW (CHAIN 1).
## 
## Chain 1, Iteration:    1 / 10000 [  0%]  (Warmup)
## Chain 1, Iteration: 1000 / 10000 [ 10%]  (Warmup)
## Chain 1, Iteration: 1001 / 10000 [ 10%]  (Sampling)
## Chain 1, Iteration: 2000 / 10000 [ 20%]  (Sampling)
## Chain 1, Iteration: 3000 / 10000 [ 30%]  (Sampling)
## Chain 1, Iteration: 4000 / 10000 [ 40%]  (Sampling)
## Chain 1, Iteration: 5000 / 10000 [ 50%]  (Sampling)
## Chain 1, Iteration: 6000 / 10000 [ 60%]  (Sampling)
## Chain 1, Iteration: 7000 / 10000 [ 70%]  (Sampling)
## Chain 1, Iteration: 8000 / 10000 [ 80%]  (Sampling)
## Chain 1, Iteration: 9000 / 10000 [ 90%]  (Sampling)
## Chain 1, Iteration: 10000 / 10000 [100%]  (Sampling)
##  Elapsed Time: 6.5 seconds (Warm-up)
##                44.02 seconds (Sampling)
##                50.52 seconds (Total)</code></pre>
<p><code>rstan</code> typically throws a number of exceptions which are usually harmless. The <code>MADPop</code> package lists <code>rstan</code> as a dependency, such that its sophisticated tuning mechanism is exposed. Optionally, <code>hUM.post</code> returns the entire <code>rstan</code> output (<code>full.stan.output = TRUE</code>), which can be run through <code>rstan</code>’s MCMC convergence diagnostics.</p>
<p>By setting the <code>rhoId</code> argument of <code>hUM.post</code>, the <code>fit0</code> object contains samples from <span class="math inline">\(p({\boldsymbol \alpha}, {\boldsymbol \rho}_{12} \mid {\boldsymbol Y}, H_0)\)</span>. Boxplots of the 50 highest posterior probability genotypes in the common distribution <span class="math inline">\({\boldsymbol \rho}_{12}\)</span> are displayed below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rho.post &lt;-<span class="st"> </span>fit0$rho[,<span class="dv">1</span>,]   <span class="co"># p(rho12 | Y)</span>
<span class="co"># sort genotype counts by decreasing order</span>
rho.count &lt;-<span class="st"> </span><span class="kw">colSums</span>(Xsuff$tab[popId,])
rho.ord &lt;-<span class="st"> </span><span class="kw">order</span>(<span class="kw">colMeans</span>(rho.post), <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)

<span class="co"># plot</span>
nbxp &lt;-<span class="st"> </span><span class="dv">50</span>            <span class="co"># number of genotypes for which to make boxplots</span>
clrs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;#999999&quot;</span>, <span class="st">&quot;#E69F00&quot;</span>, <span class="st">&quot;#56B4E9&quot;</span>, <span class="st">&quot;#009E73&quot;</span>, <span class="st">&quot;#F0E442&quot;</span>, <span class="st">&quot;#0072B2&quot;</span>,
          <span class="st">&quot;#D55E00&quot;</span>, <span class="st">&quot;#CC79A7&quot;</span>)
rho.ct &lt;-<span class="st"> </span>rho.count[rho.ord[<span class="dv">1</span>:nbxp]]
rho.lgd &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">sort</span>(rho.ct))
rho.box &lt;-<span class="st"> </span>rho.post[,rho.ord[<span class="dv">1</span>:nbxp]]
<span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="fl">4.5</span>,.<span class="dv">5</span>,.<span class="dv">5</span>)+.<span class="dv">1</span>, <span class="dt">cex.axis =</span> .<span class="dv">7</span>)
<span class="kw">boxplot</span>(<span class="dt">x =</span> rho.box,
        <span class="dt">las =</span> <span class="dv">2</span>, <span class="dt">col =</span> clrs[rho.ct<span class="dv">+1</span>], <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex =</span> .<span class="dv">2</span>)
<span class="kw">title</span>(<span class="dt">xlab =</span> <span class="st">&quot;Genotype&quot;</span>, <span class="dt">line =</span> <span class="dv">4</span>)
<span class="kw">title</span>(<span class="dt">ylab =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">bold</span>(rho)[(<span class="dv">12</span>)]*<span class="st">&quot; | &quot;</span>*<span class="kw">bold</span>(Y))))
<span class="kw">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="dt">legend =</span> <span class="kw">rev</span>(rho.lgd), <span class="dt">fill =</span> <span class="kw">rev</span>(clrs[rho.lgd<span class="dv">+1</span>]),
       <span class="dt">title =</span> <span class="st">&quot;Counts&quot;</span>, <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">cex =</span> .<span class="dv">8</span>)</code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="calculating-the-posterior-p-value" class="section level3">
<h3>Calculating the Posterior P-Value</h3>
<p>This is calculated analogously to the bootstrapped p-value, by generating <span class="math inline">\(M\)</span> contingency tables with <span class="math inline">\({\boldsymbol Y}_k^{(m)} {\stackrel{\textrm{ind}}{\sim}}\textrm{Multinomial}(N_k, {\boldsymbol \rho}_{12}^{(m)}\)</span>, <span class="math inline">\(m = 1, \ldots, M\)</span>. However, for each contingency table, the common probability vector <span class="math inline">\({\boldsymbol \rho}_{12}^{(m)}\)</span> is different, corresponding to a random draw from <span class="math inline">\(p({\boldsymbol \rho}_{12} \mid {\boldsymbol Y}, H_0)\)</span>. The test statistic <span class="math inline">\(T^{(m)}\)</span> is then calculated and we have <span class="math display">\[
{\textrm{p}_\textrm{v}^{\textrm{post}}}= \frac 1 M \sum_{m=1}^M \delta(T^{(m)} \ge T_{\textrm{obs}}).
\]</span> <span class="math inline">\({\textrm{p}_\textrm{v}^{\textrm{post}}}\)</span> is calculated with <strong>MADPop</strong> as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  T.post &lt;-<span class="st"> </span><span class="kw">UM.eqtest</span>(<span class="dt">N1 =</span> N1, <span class="dt">N2 =</span> N2, <span class="dt">p0 =</span> rho.post, <span class="dt">nreps =</span> <span class="fl">1e4</span>,
                      <span class="dt">verbose =</span> <span class="ot">FALSE</span>)
})</code></pre></div>
<pre><code>##    user  system elapsed 
##    1.42    0.00    1.42</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># posterior p-value</span>
pv.post &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">t</span>(T.post) &gt;=<span class="st"> </span>T.obs)</code></pre></div>
<p>We can now compare the three types of p-values (asymptotic, bootstrapped, posterior) for each test statistic (<span class="math inline">\(\mathcal X\)</span> and <span class="math inline">\(\Lambda\)</span>):</p>
<table>
<caption>p-value (<span class="math inline">\(\times100\%\)</span>)</caption>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Asymptotic</th>
<th align="right">Bootstrap</th>
<th align="right">Posterior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\mathcal X\)</span></td>
<td align="right">33.0</td>
<td align="right">0.74</td>
<td align="right">13</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\Lambda\)</span></td>
<td align="right">4.1</td>
<td align="right">0.68</td>
<td align="right">13</td>
</tr>
</tbody>
</table>
<p>We see that <span class="math inline">\({\textrm{p}_\textrm{v}^{\textrm{post}}}\)</span> is much more conservative than <span class="math inline">\({\textrm{p}_\textrm{v}^{\textrm{boot}}}\)</span>.</p>
</div>
</div>
<div id="future-work" class="section level2">
<h2>Future Work</h2>
<p>Here we used a completely unconstrained Multinomial model for the genotype counts, in the sense that the only restriction on <span class="math inline">\({\boldsymbol \rho}_k\)</span> is that <span class="math inline">\(\rho_{ki} \ge 0\)</span> and <span class="math inline">\(\sum_{i=1}^C \rho_{ki} = 1\)</span>. However, it is possible to impose genetic constraints such as Hardy-Weinberg equilibrium, preferential mating, etc., which effectively reduce the degrees of freedom of <span class="math inline">\({\boldsymbol \rho}_k\)</span> below <span class="math inline">\(C-1\)</span>. In this case, the closed-form likelihood <span class="math inline">\({\mathcal L}({\boldsymbol \alpha}\mid {\boldsymbol Y})\)</span> is typically unavailable, but the <strong>stan</strong> code can easily be modified to sample from <span class="math inline">\(p({\boldsymbol \alpha}, {\boldsymbol{\mathcal R}}\mid {\boldsymbol Y})\)</span>, where <span class="math inline">\({\boldsymbol{\mathcal R}}= ({\boldsymbol \rho}_1, \ldots, {\boldsymbol \rho}_K)\)</span>. We hope to feature some of these extensions to the basic Dirichlet-Multinomial model in the next version of <strong>MADPop</strong>.</p>
<!-- ```{r, echo = FALSE} -->
<!-- # kable(as.data.frame(as.list(count0)))   # counts in each lake -->
<!-- ``` -->
</div>
<div id="references" class="section level2 unnumbered">
<h2>References</h2>
<div id="refs" class="references">
<div id="ref-minka00">
<p>Minka, T.P. 2000. “Estimating a Dirichlet Distribution.” <em>Technical Report</em>. Massachusetts Institute of Technology. <a href="https://tminka.github.io/papers/dirichlet/minka-dirichlet.pdf" class="uri">https://tminka.github.io/papers/dirichlet/minka-dirichlet.pdf</a>.</p>
</div>
<div id="ref-rstan">
<p>Stan Development Team. 2016. “Rstan: The R Interface to Stan.” <a href="http://mc-stan.org" class="uri">http://mc-stan.org</a>.</p>
</div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
