---
title: "Bayesian Testing of Equal Genotypic Proportions between Populations"
author: "Terin Robinson, Martin Lysy, Peter W.J. Kim"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette

vignette: >
  %\VignetteIndexEntry{Bayesian Testing of Equal Genotypic Proportions between Populations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This tutorial shows how to compute Bayesian posterior p-values for the usual chi-squared ($\mathcal X$) and likelihood ratio ($\Lambda$) statistics under a hierarchical model.
```{r}
require(MADPop)
```

## Data

Input data must be formatted properly to use with the functions in **MADPop**.  An example `fish215.csv` file is provided in the package's **extdata** folder.  Once imported the data should look like this:
```{r}
head(fish215)
```
Describe what each of the values means in terms of lakes and alleles.

This data is converted into a numeric format to be used with **MADPop** with the command
```{r}
Xsuff <- UM.suff(fish215)
```
`Xsuff` is a list with three components:

* `A`: The allele names found in the data frame `fish215`.  Each is encoded by a number in the given order.
```{r}
head(Xsuff$A)
```
* `G`: A 4-column matrix of unique numerical genotypes.  Alleles are sorted and missing alleles (either non-existent in the fish or duplicates which our instrumentation cannot resolve) are denoted by zeros.
```{r}
dim(Xsuff$G) # 134 unique genotypes
Xsuff$G[1,] # observed genotype is "3"
Xsuff$G[20,] # observed genotype is "1.8"
```
* `tab`: A contingency table giving the number of counts of each genotype category in each lake.
```{r}
Xsuff$tab[,1:10] # 11 lakes and 120 more genotypes
```

## Model and Null Hypothesis

Let $Y_k$ denote the unique genotype categories...
The model is
$$ Y_k | \rho_k \stackrel{\textrm{ind}}{\sim} \textrm{Multinomial}(\rho_k, N_k), \qquad \rho_k \stackrel{\textrm{iid}}{\sim} \textrm{Dirichlet}(\alpha), \qquad (\bar \alpha, \alpha_0) \sim \frac{1}{(1 + \alpha_0)^2},$$
where $\alpha_0 = \sum_{j=1}^C \alpha_j$ and $\bar \alpha = \alpha/\alpha_0$.

## Estimating the Common Vector of Genotype Proportions

This is done using stan.
```{r}
lnames <- c("Michipicoten", "Simcoe") # two lakes under consideration
# popId vector which merges these two lakes under the null
popId0 <- paste(lnames, collapse = ".")
popId0 # common lake name
popId <- as.character(fish215$Lake)
popId[popId %in% lnames] <- popId0
table(popId) # all lake names
allele0 <- cbind(popId, fish215[,-1]) # data with merged lakes

# posterior inference in stan
# don't make too big during development or this will take forever
# eventually should use nsamples = 1e4
nsamples <- 1e3
hUM.fit <- hUM.post(nsamples = nsamples, X = allele0,
                    rhoId = popId0, # output only merged lakes to save space
                    chains = 1, # next two arguments are passed to stan
                    warmup = min(1e4, floor(nsamples/10)))
rho.post <- hUM.fit$rho[,1,] # convert 3-d array to 2-d matrix
```
The posterior distributions of the 20 most probable genotype are plotted below (run the command `edit(vignette(MADPop-tutorial))` to see the code).
```{r, fig.width = 7, fig.height = 3.5}
propId <- order(colMeans(rho.post))[1:20]
par(mar = c(5,4,.1,.1))
boxplot(rho.post[,propId],
        las = 2, pch = ".", col = "grey", cex.axis = .8,
        xlab = "Genotype", ylab = "Probability")
```

## Posterior p-value Calculation

Let $T$ denote any test statistic for evaluating the null hypothesis that lakes Michipicoten and Simcoe have the same genotype proportions.  Two of the most popular statistics to this end are:

* *Pearson's chi-squared statistic*:
$$ \mathcal X = ??? $$
* The *likelihood ratio statistic*:
$$ \Lambda = ??? $$

With $T_{\textrm{obs}}$ being the observed value of the test statistic in the data at hand, the posterior p-value is defined as
$$
p_{\textrm{post}} = \textrm{Pr}(T > T_{\textrm{obs}} | data, H_0).
$$
This is calculated in **MADPop** by using `rho.post` to generate samples from $p(T | data, H_0)$:
```{r}
# number of observations in each lake
N1 <- sum(Xsuff$tab["Michipicoten",])
N2 <- sum(Xsuff$tab["Simcoe",])
# generate samples from p(T | data, H_0)
T.post <- UM.eqtest(N1 = N1, N2 = N2, p0 = rho.post, nreps = 1e4)
head(T.post) # computes both chi^2 and LRT
# calculate T.obs
tab.obs <- Xsuff$tab[lnames,] # observed table
# automatically removes categories where both lakes have zero observations
T.obs <- c(chi2 = chi2.stat(tab.obs),
           LRT = LRT.stat(tab.obs))
p.post <- c(chi2 = mean(T.post[,"chi2"] >= T.obs["chi2"]),
            LRT = mean(T.post[,"LRT"] >= T.obs["LRT"]))
p.post # posterior p-values
```
